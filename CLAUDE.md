# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project: Gemini Plant Diagnosis MCP Server

**Region-agnostic plant disease diagnosis service that provides structured diagnostic data via Model Context Protocol (MCP). Uses Google Gemini 2.0 Flash vision model for image analysis.**

## Architecture Overview

This is a **pure diagnostic service** that:
1. Receives plant images via MCP protocol
2. Analyzes images using Google Gemini 2.0 Flash vision model
3. Returns structured diagnostic data ONLY (crop ID, health status, issues, growth stage)
4. Does NOT provide treatment recommendations or region-specific advice

**Critical: This MCP server is region-agnostic. It provides ONLY diagnosis. Treatment recommendations should be generated by the calling Agent Builder based on farmer's region.**

## Key Principle: Separation of Concerns

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Plant Image                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Gemini Plant Diagnosis MCP Server (THIS SERVICE)       â”‚
â”‚  - Identifies crop species                              â”‚
â”‚  - Detects diseases, pests, deficiencies                â”‚
â”‚  - Provides scientific names, severity, symptoms        â”‚
â”‚  - Returns structured diagnostic data                   â”‚
â”‚  - NO TREATMENT RECOMMENDATIONS                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ Diagnostic Data
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  OpenAI Agent Builder (FarmerChat Workflow)             â”‚
â”‚  - Receives diagnostic data from MCP                    â”‚
â”‚  - Generates region-specific treatment advice           â”‚
â”‚  - Provides farmer-friendly recommendations             â”‚
â”‚  - Adapts to local context (East Africa, India, etc.)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Key Files

### src/index.ts (Main Server)
- Express.js server with MCP StreamableHTTP transport
- One MCP tool: `diagnose_plant_disease`
- Gemini 2.0 Flash vision model integration
- Structured diagnostic output format

### test-diagnosis.js
- Test script to send plant images to MCP endpoint
- Handles server-sent events (SSE) response format
- Reads images from desktop S3_IMAGES folder

## Development Commands

```bash
# Install dependencies
npm install

# Development (with auto-reload)
npm run dev

# Build TypeScript
npm run build

# Production
npm start

# Test locally
node test-diagnosis.js [path-to-image.jpg]

# Test health endpoint
curl http://localhost:3001/health
```

## MCP Tool: diagnose_plant_disease

### Parameters
- **image** (required): Base64-encoded plant image
  - Format: `data:image/jpeg;base64,/9j/4AAQ...`
  - Supported: JPEG, PNG, WebP
  - Max size: 5MB

- **crop** (optional): Expected crop type for validation
  - If provided, tool validates if image matches expected crop
  - Examples: `maize`, `tomato`, `potato`, `coffee`

### Response Format

The tool returns a structured diagnostic report:

```
ğŸŒ± **CROP IDENTIFICATION:**
Crop: [Name] (Scientific: [Latin name]) - Confidence: [High/Medium/Low]
[If crop mismatch: clearly states mismatch]

ğŸ” **HEALTH STATUS:**
Overall health: [Healthy/Mild Issue/Moderate Issue/Severe Issue/Critical]
Confidence: [High/Medium/Low]

âš ï¸ **ISSUE DETECTION:**

**Issue 1: [Disease/Pest/Deficiency Name]**
- Scientific name: [Latin name]
- Category: [Disease/Pest/Nutrient Deficiency/Physical Damage/Other]
- Severity: [Low/Moderate/High/Critical]
- Stage: [Early/Active/Advanced]
- Affected parts: [Leaves/Stem/Roots/Fruit/Flowers/Entire plant]
- Visible symptoms: [Detailed list]
- Causal agent: [Fungus/Bacteria/Virus/Insect/Mite/Environmental/Unknown]

[Repeat for each issue]

ğŸ“Š **GROWTH STAGE:**
[Seedling/Vegetative/Flowering/Fruiting/Mature/Senescent]

ğŸ”¬ **DIAGNOSTIC NOTES:**
[Additional observations, differential diagnosis, uncertainty notes]
```

### What This Tool Does NOT Provide
- âŒ Treatment recommendations
- âŒ Regional farming advice
- âŒ Specific product recommendations
- âŒ Application methods
- âŒ Farmer-friendly language (uses technical/botanical terms)

**The calling agent (Agent Builder) should:**
- Take diagnostic data from this tool
- Generate region-specific treatment advice
- Provide farmer-friendly recommendations
- Adapt to local agricultural context

## Supported Crops (23)

**Cereals:** maize, wheat, rice, sorghum, millet
**Legumes:** beans, cowpea, pigeon_pea, groundnut
**Roots:** cassava, sweet_potato, potato
**Vegetables:** tomato, cabbage, kale, onion, vegetables
**Cash Crops:** tea, coffee, sugarcane, banana, sunflower, cotton

## Gemini Prompt Strategy

The prompt instructs Gemini to:
1. **Always identify crop first** (with confidence level)
2. **Validate against expected crop** if provided in parameters
3. **Detect issues** with scientific precision (scientific names, causal agents)
4. **Use botanical/pathological terminology** (not farmer language)
5. **Provide structured data** following exact format
6. **Never suggest treatments** - diagnosis only

## Environment Variables

Required:
```bash
GEMINI_API_KEY=<key>  # Google AI Studio API key
```

Optional:
```bash
PORT=3001              # Default: 3001
NODE_ENV=production
ALLOWED_ORIGINS=*      # CORS config
```

### Getting a Gemini API Key

1. Go to [Google AI Studio](https://makersuite.google.com/app/apikey)
2. Sign in with Google account
3. Create new API key
4. Copy to .env file

## Testing Locally

```bash
# Start server
npm run dev

# In another terminal, test with plant image:
node test-diagnosis.js

# Or specify custom image:
node test-diagnosis.js /path/to/plant-image.jpg

# Expected output: Structured diagnostic report with NO treatment advice
```

### Test Images
Available in `/Users/eagleisbatman/Desktop/S3_IMAGES/` folder.

**Example Test Results:**

1. **Potato with beetle infestation**
   - Correctly identified potato (not maize as requested)
   - Detected Colorado Potato Beetle larvae
   - Listed visible symptoms, severity, affected parts
   - NO treatment recommendations

2. **Maize with ear rot**
   - Identified maize correctly
   - Detected fungal ear rot (Fusarium, Aspergillus, Diplodia complex)
   - Provided diagnostic notes about growth stage
   - NO treatment recommendations

## Integration with FarmerChat Agent Builder

### Agent Builder System Prompt Should Include:

```markdown
## Plant Diagnosis Tool

When users share plant images, use the `diagnose_plant_disease` tool to get diagnostic information.

The tool returns ONLY diagnostic data:
- Crop identification
- Health status
- Detected issues (diseases/pests/deficiencies)
- Growth stage
- Diagnostic notes

**Important**: The tool does NOT provide treatment recommendations.

After receiving diagnostic data, YOU must:
1. Generate region-specific treatment advice based on farmer's location
2. Adapt recommendations to local agricultural practices
3. Provide farmer-friendly language (translate technical terms)
4. Suggest locally available treatments and products
5. Include preventive measures appropriate for the region

Example flow:
1. User uploads plant image
2. Call diagnose_plant_disease tool
3. Receive: "Crop: Maize, Issue: Fusarium ear rot, Severity: Moderate"
4. Generate response: "Your maize has ear rot caused by fungus. For Kenya, here's what to do..."
```

## Deployment to Railway

### 1. Create railway.json

```json
{
  "$schema": "https://railway.app/railway.schema.json",
  "build": {
    "builder": "NIXPACKS"
  },
  "deploy": {
    "startCommand": "npm start",
    "healthcheckPath": "/health",
    "healthcheckTimeout": 300,
    "restartPolicyType": "ON_FAILURE",
    "restartPolicyMaxRetries": 3
  }
}
```

### 2. Set Environment Variables in Railway Dashboard
- `GEMINI_API_KEY` (required)
- `PORT` (Railway sets automatically)
- `NODE_ENV=production`

### 3. Deploy
```bash
railway login
railway link
railway up
```

### 4. Verify Deployment
```bash
# Test health endpoint
curl https://your-app.up.railway.app/health

# Should return:
{
  "status": "healthy",
  "service": "gemini-plant-diagnosis-mcp",
  "geminiConfigured": true,
  "version": "1.0.0"
}
```

### 5. Add to OpenAI Agent Builder
1. Go to platform.openai.com
2. Navigate to FarmerChat workflow
3. Add new MCP connection:
   - Name: Plant Diagnosis
   - URL: https://your-app.up.railway.app/mcp
   - Type: StreamableHTTP
4. Update system prompt to use diagnostic data for regional advice
5. Save workflow

## API Endpoints

### GET /health
Health check endpoint.

**Response:**
```json
{
  "status": "healthy",
  "service": "gemini-plant-diagnosis-mcp",
  "geminiConfigured": true,
  "supportedCrops": 23,
  "version": "1.0.0",
  "timestamp": "2025-10-11T..."
}
```

### GET /
Server information.

**Response:**
```json
{
  "service": "Gemini Plant Diagnosis MCP Server",
  "version": "1.0.0",
  "description": "Region-agnostic plant disease diagnosis...",
  "endpoints": {
    "health": "/health",
    "mcp": "/mcp (POST)"
  },
  "tools": ["diagnose_plant_disease"],
  "supportedCrops": 23
}
```

### POST /mcp
MCP protocol endpoint for tool calls.

## Error Handling

The tool handles various scenarios:

- **No API key**: Returns configuration error
- **Invalid image format**: Requests valid JPEG/PNG/WebP
- **Image too large**: Requests smaller image (< 5MB)
- **API quota exceeded**: Informs of temporary unavailability
- **Unclear image**: Indicates image doesn't show plant clearly
- **Non-plant image**: States that image doesn't contain a plant

All errors are returned in structured format without treatment advice.

## Code Quality Guidelines

### When Modifying Diagnostic Prompt
- Keep prompt region-agnostic (no East Africa, no Kenya-specific advice)
- Focus on botanical/pathological terminology
- Ensure structured format is maintained
- Never add treatment recommendations to prompt
- Test that output remains diagnostic-only

### When Adding Features
- Follow existing MCP tool pattern
- Maintain separation of concerns (diagnosis vs. treatment)
- Add descriptive logging: `console.log('[MCP Tool] ...')`
- Return structured data, not farmer-friendly prose
- Update tool descriptions to emphasize diagnostic-only nature

### TypeScript Patterns
- Use z.enum() for crop types
- Type Gemini API responses
- Handle errors gracefully without suggesting treatments

## Common Issues

**"Responses include treatment advice"**
- Review Gemini prompt - should explicitly forbid treatments
- Check that Agent Builder system prompt is taking over treatment advice
- Test with fresh images to verify diagnostic-only output

**"Tool not working in Agent Builder"**
- Verify Railway deployment is running
- Check MCP endpoint URL is correct
- Test health endpoint: `curl https://<app>.up.railway.app/health`
- Review Railway logs for errors

**"Low accuracy on crop identification"**
- Ensure images clearly show plant characteristics
- Provide crop parameter for validation
- Check image resolution and quality
- Verify image is not corrupt or too small

## Related Projects

- **gap-mcp-server**: Weather and farming advisory MCP server (also region-agnostic at data layer)
- **gap-chat-widget**: FarmerChat UI with ChatKit integration (handles regional context)

## Support

For issues and questions, contact Digital Green Foundation or open an issue in the repository.
