# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project: AgriVision MCP Server

**AI-powered plant disease and health diagnosis service via Model Context Protocol (MCP). Uses Google Gemini vision models (default: 2.5 Flash) for accurate image analysis. Configurable to provide diagnosis-only data or full advisory with treatment recommendations.**

## Architecture Overview

This is a **configurable plant health diagnosis service** that:
1. Receives plant images via MCP protocol
2. Analyzes images using Google Gemini vision models (configurable)
3. Returns diagnostic data based on ADVISORY_MODE:
   - **diagnosis_only** (default): Crop ID, health status, issues, symptoms, severity ONLY
   - **full_advisory**: Diagnosis + AI-generated treatment recommendations (organic/chemical options, preventive measures)
4. Formats output based on OUTPUT_FORMAT:
   - **structured** (default): Clear sections with emojis and structured formatting
   - **text**: Detailed narrative format with enhanced readability

**Important: In diagnosis_only mode, this MCP server is region-agnostic. It provides ONLY diagnostic data. Treatment recommendations should be generated by the calling Agent Builder based on the farmer's region.**

## Key Principle: Configurable Architecture

### diagnosis_only Mode (Region-Agnostic)
```
┌─────────────────────────────────────────────────────────┐
│  Plant Image                                             │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│  AgriVision MCP Server (THIS SERVICE)                   │
│  Mode: diagnosis_only                                   │
│  - Identifies crop species                              │
│  - Detects diseases, pests, deficiencies                │
│  - Provides scientific names, severity, symptoms        │
│  - Returns structured diagnostic data                   │
│  - NO TREATMENT RECOMMENDATIONS                         │
└────────────────────┬────────────────────────────────────┘
                     │ Diagnostic Data
                     ▼
┌─────────────────────────────────────────────────────────┐
│  OpenAI Agent Builder (FarmerChat Workflow)             │
│  - Receives diagnostic data from MCP                    │
│  - Generates region-specific treatment advice           │
│  - Provides farmer-friendly recommendations             │
│  - Adapts to local context (East Africa, India, etc.)  │
└─────────────────────────────────────────────────────────┘
```

### full_advisory Mode (Complete Solution)
```
┌─────────────────────────────────────────────────────────┐
│  Plant Image                                             │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│  AgriVision MCP Server (THIS SERVICE)                   │
│  Mode: full_advisory                                    │
│  - Identifies crop species                              │
│  - Detects diseases, pests, deficiencies                │
│  - Provides scientific names, severity, symptoms        │
│  - INCLUDES AI-generated treatment recommendations      │
│  - Organic & chemical options                           │
│  - Preventive measures                                  │
└────────────────────┬────────────────────────────────────┘
                     │ Complete Diagnostic Report
                     ▼
┌─────────────────────────────────────────────────────────┐
│  OpenAI Agent Builder / Direct Integration              │
│  - Receives complete diagnosis + treatment              │
│  - Can enhance with region-specific context             │
│  - Simplifies workflow (one-stop solution)              │
└─────────────────────────────────────────────────────────┘
```

## Key Files

### src/index.ts (Main Server)
- Express.js server with MCP StreamableHTTP transport
- One MCP tool: `diagnose_plant_health`
- Google Gemini vision model integration (configurable via GEMINI_IMAGE_MODEL)
- Configurable advisory mode (ADVISORY_MODE)
- Configurable output format (OUTPUT_FORMAT)
- Dynamic prompt construction based on configuration

### test-diagnosis.js
- Test script to send plant images to MCP endpoint
- Handles server-sent events (SSE) response format
- Reads images from desktop S3_IMAGES folder

## Development Commands

```bash
# Install dependencies
npm install

# Development (with auto-reload)
npm run dev

# Build TypeScript
npm run build

# Production
npm start

# Test locally
node test-diagnosis.js [path-to-image.jpg]

# Test health endpoint
curl http://localhost:3001/health
```

## MCP Tool: diagnose_plant_health

### Parameters
- **image** (required): Base64-encoded plant image
  - Format: `data:image/jpeg;base64,/9j/4AAQ...`
  - Supported: JPEG, PNG, WebP
  - Max size: 5MB

- **crop** (optional): Expected crop type for validation
  - If provided, tool validates if image matches expected crop
  - Examples: `maize`, `tomato`, `potato`, `coffee`

### Response Format

The tool returns a structured diagnostic report:

```
🌱 **CROP IDENTIFICATION:**
Crop: [Name] (Scientific: [Latin name]) - Confidence: [High/Medium/Low]
[If crop mismatch: clearly states mismatch]

🔍 **HEALTH STATUS:**
Overall health: [Healthy/Mild Issue/Moderate Issue/Severe Issue/Critical]
Confidence: [High/Medium/Low]

⚠️ **ISSUE DETECTION:**

**Issue 1: [Disease/Pest/Deficiency Name]**
- Scientific name: [Latin name]
- Category: [Disease/Pest/Nutrient Deficiency/Physical Damage/Other]
- Severity: [Low/Moderate/High/Critical]
- Stage: [Early/Active/Advanced]
- Affected parts: [Leaves/Stem/Roots/Fruit/Flowers/Entire plant]
- Visible symptoms: [Detailed list]
- Causal agent: [Fungus/Bacteria/Virus/Insect/Mite/Environmental/Unknown]

[Repeat for each issue]

📊 **GROWTH STAGE:**
[Seedling/Vegetative/Flowering/Fruiting/Mature/Senescent]

🔬 **DIAGNOSTIC NOTES:**
[Additional observations, differential diagnosis, uncertainty notes]
```

### What This Tool Provides (Based on Mode)

**diagnosis_only Mode (default):**
- ✅ Crop identification with scientific names
- ✅ Health status assessment
- ✅ Disease/pest/deficiency detection
- ✅ Symptoms and severity analysis
- ✅ Growth stage identification
- ❌ NO treatment recommendations
- ❌ NO regional farming advice

**full_advisory Mode:**
- ✅ Everything from diagnosis_only, PLUS:
- ✅ Treatment recommendations (organic & chemical)
- ✅ Application methods and dosages
- ✅ Preventive measures
- ✅ Cultural practice suggestions
- ⚠️ General recommendations (not region-specific)

**When using diagnosis_only mode, the calling agent (Agent Builder) should:**
- Take diagnostic data from this tool
- Generate region-specific treatment advice based on farmer's location
- Provide farmer-friendly recommendations
- Adapt to local agricultural context and available products

## Supported Crops (23)

**Cereals:** maize, wheat, rice, sorghum, millet
**Legumes:** beans, cowpea, pigeon_pea, groundnut
**Roots:** cassava, sweet_potato, potato
**Vegetables:** tomato, cabbage, kale, onion, vegetables
**Cash Crops:** tea, coffee, sugarcane, banana, sunflower, cotton

## AI Vision Prompt Strategy

The prompt is dynamically constructed based on configuration:

### diagnosis_only Mode:
1. **Always identify crop first** (with confidence level)
2. **Validate against expected crop** if provided in parameters
3. **Detect issues** with scientific precision (scientific names, causal agents)
4. **Use botanical/pathological terminology**
5. **Provide structured diagnostic data** following exact format
6. **Never suggest treatments** - diagnosis only

### full_advisory Mode:
1-5. Same as diagnosis_only, PLUS:
6. **Include treatment recommendations section** with:
   - Organic treatment options (methods, timing, frequency)
   - Chemical treatment options (active ingredients, dosage, safety)
   - Preventive measures (cultural practices, IPM)
   - Important notes about consulting local experts

### Output Format Variations:
- **structured**: Maintains emoji headers and clear section breaks
- **text**: More narrative style while preserving all information

## Environment Variables

### Required:
```bash
GEMINI_API_KEY=<key>  # Google AI Studio API key (required for AI vision)
```

### Configuration Options:
```bash
# AI Model Selection
GEMINI_IMAGE_MODEL=gemini-2.5-flash-image-preview  # Default
# Alternatives: gemini-2.0-flash-exp, gemini-1.5-pro, gemini-1.5-flash

# Advisory Mode (IMPORTANT)
ADVISORY_MODE=diagnosis_only  # Default - Returns diagnostic data only
# Options:
#   - diagnosis_only: Crop ID, health, issues, symptoms (region-agnostic)
#   - full_advisory: Includes AI treatment recommendations

# Output Format
OUTPUT_FORMAT=structured  # Default - Clear sections with emojis
# Options:
#   - structured: Organized sections with emoji headers
#   - text: Narrative format with enhanced readability
```

### Server Configuration:
```bash
PORT=3001              # Default: 3001
NODE_ENV=production
ALLOWED_ORIGINS=*      # CORS config
```

### Getting a Gemini API Key

1. Go to [Google AI Studio](https://makersuite.google.com/app/apikey)
2. Sign in with Google account
3. Create new API key
4. Copy to .env file

## Testing Locally

```bash
# Start server
npm run dev

# In another terminal, test with plant image:
node test-diagnosis.js

# Or specify custom image:
node test-diagnosis.js /path/to/plant-image.jpg

# Test different configurations:
# 1. diagnosis_only mode (default .env)
ADVISORY_MODE=diagnosis_only npm run dev
# Expected output: Diagnostic data ONLY, no treatment recommendations

# 2. full_advisory mode
ADVISORY_MODE=full_advisory npm run dev
# Expected output: Diagnosis + treatment recommendations

# 3. Different output formats
OUTPUT_FORMAT=text npm run dev
# Expected output: More narrative style

# 4. Different AI model
GEMINI_IMAGE_MODEL=gemini-2.0-flash-exp npm run dev
# Expected output: Same structure, different model performance
```

### Test Images
Available in `/Users/eagleisbatman/Desktop/S3_IMAGES/` folder.

**Example Test Results (diagnosis_only mode):**

1. **Potato with beetle infestation**
   - Correctly identified potato (not maize as requested)
   - Detected Colorado Potato Beetle larvae
   - Listed visible symptoms, severity, affected parts
   - NO treatment recommendations (as expected)

2. **Maize with ear rot**
   - Identified maize correctly
   - Detected fungal ear rot (Fusarium, Aspergillus, Diplodia complex)
   - Provided diagnostic notes about growth stage
   - NO treatment recommendations (as expected)

**Example Test Results (full_advisory mode):**

1. **Same potato image**
   - Same diagnostic information, PLUS:
   - Organic treatment options (handpicking, neem oil)
   - Chemical options (insecticides with active ingredients)
   - Preventive measures (crop rotation, monitoring)

2. **Same maize image**
   - Same diagnostic information, PLUS:
   - Fungicide recommendations (active ingredients)
   - Cultural practices (field sanitation, proper drying)
   - Preventive measures (resistant varieties, crop rotation)

## Integration with Agent Builder / Applications

### For diagnosis_only Mode (Region-Agnostic)

**Agent Builder System Prompt Should Include:**

```markdown
## Plant Health Assessment Tool (AgriVision)

When users share plant images, use the `diagnose_plant_health` tool to assess overall plant health.

**Mode: diagnosis_only** - The tool returns ONLY diagnostic data:
- Crop identification with scientific names
- Health status assessment
- Detected issues (diseases/pests/deficiencies) with symptoms
- Growth stage
- Diagnostic notes

**Important**: The tool does NOT provide treatment recommendations.

After receiving diagnostic data, YOU must:
1. Generate region-specific treatment advice based on farmer's location
2. Adapt recommendations to local agricultural practices
3. Provide farmer-friendly language (translate technical terms)
4. Suggest locally available treatments and products
5. Include preventive measures appropriate for the region

Example flow:
1. User uploads plant image
2. Call diagnose_plant_health tool
3. Receive: "Crop: Maize, Health Status: Moderate Issue, Issue: Fusarium ear rot, Severity: Moderate"
4. Generate response: "Your maize has ear rot caused by fungus. For Kenya, here's what to do..."
```

### For full_advisory Mode (Complete Solution)

**Agent Builder System Prompt Should Include:**

```markdown
## Plant Health Assessment Tool (AgriVision)

When users share plant images, use the `diagnose_plant_health` tool to get comprehensive health assessment and advisory information.

**Mode: full_advisory** - The tool returns:
- Complete diagnostic data (crop ID, health, issues, symptoms)
- Treatment recommendations (organic & chemical options)
- Application methods and dosages
- Preventive measures and cultural practices

The tool provides general treatment recommendations. YOU should:
1. Enhance with region-specific context if farmer provides location
2. Add information about locally available products/brands
3. Translate technical terms to farmer-friendly language
4. Emphasize safety and proper application methods
```

## Deployment to Railway

### 1. Create railway.json

```json
{
  "$schema": "https://railway.app/railway.schema.json",
  "build": {
    "builder": "NIXPACKS"
  },
  "deploy": {
    "startCommand": "npm start",
    "healthcheckPath": "/health",
    "healthcheckTimeout": 300,
    "restartPolicyType": "ON_FAILURE",
    "restartPolicyMaxRetries": 3
  }
}
```

### 2. Set Environment Variables in Railway Dashboard
- `GEMINI_API_KEY` (required)
- `GEMINI_IMAGE_MODEL` (optional, default: gemini-2.5-flash-image-preview)
- `ADVISORY_MODE` (optional, default: diagnosis_only)
- `OUTPUT_FORMAT` (optional, default: structured)
- `PORT` (Railway sets automatically)
- `NODE_ENV=production`

### 3. Deploy
```bash
railway login
railway link
railway up
```

### 4. Verify Deployment
```bash
# Test health endpoint
curl https://your-app.up.railway.app/health

# Should return:
{
  "status": "healthy",
  "service": "agrivision-mcp-server",
  "aiVisionConfigured": true,
  "model": "gemini-2.5-flash-image-preview",
  "advisoryMode": "diagnosis_only",
  "outputFormat": "structured",
  "supportedCrops": 23,
  "version": "1.0.0",
  "timestamp": "2025-10-12T..."
}
```

### 5. Add to OpenAI Agent Builder
1. Go to platform.openai.com
2. Navigate to your workflow (e.g., FarmerChat)
3. Add new MCP connection:
   - Name: AgriVision Plant Diagnosis
   - URL: https://your-app.up.railway.app/mcp
   - Type: StreamableHTTP
4. Update system prompt based on advisory mode:
   - If diagnosis_only: Agent must generate treatment advice
   - If full_advisory: Agent can use provided recommendations
5. Save workflow

## API Endpoints

### GET /health
Health check endpoint.

**Response:**
```json
{
  "status": "healthy",
  "service": "agrivision-mcp-server",
  "aiVisionConfigured": true,
  "model": "gemini-2.5-flash-image-preview",
  "advisoryMode": "diagnosis_only",
  "outputFormat": "structured",
  "supportedCrops": 23,
  "version": "1.0.0",
  "timestamp": "2025-10-12T..."
}
```

### GET /
Server information.

**Response:**
```json
{
  "service": "AgriVision MCP Server",
  "version": "1.0.0",
  "description": "AI-powered plant disease and health diagnosis using Google Gemini gemini-2.5-flash-image-preview. Region-agnostic diagnostic service providing diagnostic data only. Output format: structured.",
  "configuration": {
    "model": "gemini-2.5-flash-image-preview",
    "advisoryMode": "diagnosis_only",
    "outputFormat": "structured"
  },
  "endpoints": {
    "health": "/health",
    "mcp": "/mcp (POST)"
  },
  "tools": ["diagnose_plant_health"],
  "supportedCrops": 23
}
```

### POST /mcp
MCP protocol endpoint for tool calls.

## Error Handling

The tool handles various scenarios:

- **No API key**: Returns configuration error
- **Invalid image format**: Requests valid JPEG/PNG/WebP
- **Image too large**: Requests smaller image (< 5MB)
- **API quota exceeded**: Informs of temporary unavailability
- **Unclear image**: Indicates image doesn't show plant clearly
- **Non-plant image**: States that image doesn't contain a plant

All errors are returned in structured format without treatment advice.

## Code Quality Guidelines

### When Modifying Diagnostic Prompt
- Ensure prompt respects ADVISORY_MODE configuration
- In diagnosis_only: Keep region-agnostic, no treatment recommendations
- In full_advisory: Include comprehensive treatment sections
- Focus on botanical/pathological terminology
- Maintain structured format based on OUTPUT_FORMAT
- Test both advisory modes after changes

### When Adding Features
- Follow existing MCP tool pattern
- Respect configuration-driven behavior (ADVISORY_MODE, OUTPUT_FORMAT)
- Add descriptive logging: `console.log('[AI Vision] ...')`
- Update tool descriptions dynamically based on mode
- Test all configuration combinations

### Configuration Guidelines
- Use environment variables for all configurable behavior
- Provide sensible defaults (diagnosis_only, structured, gemini-2.5-flash)
- Document all configuration options in .env.example
- Show current configuration in startup logs
- Include configuration in health endpoint response

### TypeScript Patterns
- Use z.enum() for crop types and other enums
- Type Gemini API responses
- Handle errors gracefully with farmer-friendly messages
- Use conditional logic for mode-based behavior

## Common Issues

**"Responses include treatment advice in diagnosis_only mode"**
- Verify ADVISORY_MODE=diagnosis_only in environment
- Check Railway environment variables
- Review Gemini prompt - should explicitly forbid treatments
- Test locally with correct .env configuration
- Restart server after changing environment variables

**"Responses missing treatment advice in full_advisory mode"**
- Verify ADVISORY_MODE=full_advisory in environment
- Check Railway environment variables show full_advisory
- Test health endpoint to confirm configuration
- Review prompt construction in src/index.ts:186-286

**"Tool not working in Agent Builder"**
- Verify Railway deployment is running
- Check MCP endpoint URL is correct
- Test health endpoint: `curl https://<app>.up.railway.app/health`
- Verify configuration shows in health response
- Review Railway logs for errors

**"Low accuracy on crop identification"**
- Ensure images clearly show plant characteristics
- Provide crop parameter for validation
- Check image resolution and quality
- Verify image is not corrupt or too small
- Try different GEMINI_IMAGE_MODEL (e.g., gemini-1.5-pro for higher accuracy)

**"Configuration not taking effect"**
- Verify environment variables are set correctly
- Restart server after changing .env file
- Check startup logs show correct configuration
- Test health endpoint to verify current settings
- On Railway: ensure variables are set in dashboard, not just .env

## Related Projects

- **gap-mcp-server**: Weather and farming advisory MCP server (also region-agnostic at data layer)
- **gap-chat-widget**: FarmerChat UI with ChatKit integration (handles regional context)

## Support

For issues and questions, contact Digital Green Foundation or open an issue in the repository.
